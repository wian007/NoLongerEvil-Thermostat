{
  "openapi": "3.0.3",
  "info": {
    "title": "No Longer Evil Thermostat API",
    "description": "Documents the local API surface. The HTTPS listener emulates Nest endpoints for devices, while the HTTP listener exposes helper endpoints for dashboards and automations.",
    "version": "1.0.0"
  },
  "servers": [
    {
      "url": "https://localhost:443",
      "description": "Device proxy (PROXY_PORT)"
    },
    {
      "url": "http://localhost:8081",
      "description": "Control API (CONTROL_PORT)"
    }
  ],
  "tags": [
    {
      "name": "Control",
      "description": "User-facing helpers on the control HTTP server."
    },
    {
      "name": "Device",
      "description": "Nest-compatible endpoints on the TLS proxy."
    }
  ],
  "paths": {
    "/command": {
      "post": {
        "tags": [
          "Control"
        ],
        "summary": "Send a thermostat command",
        "operationId": "sendCommand",
        "description": "Forwards a command to the specified thermostat and persists the state.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CommandRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Command accepted",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CommandResponse"
                }
              }
            }
          },
          "400": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/status": {
      "get": {
        "tags": [
          "Control"
        ],
        "summary": "Inspect device state",
        "operationId": "getStatus",
        "parameters": [
          {
            "name": "serial",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Optional thermostat serial to scope the response and mark the user as active."
          }
        ],
        "responses": {
          "200": {
            "description": "Current cached state",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/StatusResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid query",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/devices": {
      "get": {
        "tags": [
          "Control"
        ],
        "summary": "List devices and object keys",
        "operationId": "listDevices",
        "responses": {
          "200": {
            "description": "Devices known to the control server",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/DeviceListItem"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/nest/entry": {
      "get": {
        "tags": [
          "Device"
        ],
        "summary": "Return entry point metadata",
        "operationId": "getEntryLinks",
        "description": "Devices call this endpoint after authenticating. The Authorization header or X-NL-Device-Serial header is used to infer the device serial number.",
        "security": [
          {
            "BasicAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/XNlDeviceSerial"
          }
        ],
        "responses": {
          "200": {
            "description": "Transport URLs and supporting API pointers",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EntryLinksResponse"
                }
              }
            }
          }
        }
      }
    },
    "/nest/passphrase": {
      "get": {
        "tags": [
          "Device"
        ],
        "summary": "Generate or fetch the current entry key",
        "operationId": "getEntryKey",
        "security": [
          {
            "BasicAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/XNlDeviceSerial"
          }
        ],
        "responses": {
          "200": {
            "description": "Active entry key for linking",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PassphraseResponse"
                }
              }
            }
          },
          "500": {
            "description": "Unable to generate a key",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/nest/weather/v1": {
      "get": {
        "tags": [
          "Device"
        ],
        "summary": "Proxy to the legacy Nest weather API",
        "operationId": "getWeather",
        "parameters": [
          {
            "name": "query",
            "in": "query",
            "required": true,
            "description": "Weather query formatted as `<postalCode>,<country>`. Pass `ipv4` or `ipv6` for IP-based lookups.",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Weather payload (passthrough from Nest)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WeatherResponse"
                }
              }
            }
          },
          "400": {
            "description": "Missing or invalid query parameter",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "502": {
            "description": "Weather backend unavailable",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/nest/pro_info": {
      "get": {
        "tags": [
          "Device"
        ],
        "summary": "Lookup installer information",
        "operationId": "getProInfo",
        "parameters": [
          {
            "name": "code",
            "in": "query",
            "required": false,
            "description": "Entry code to look up. `entry_code` is also accepted.",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "entry_code",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Alias for the `code` parameter."
          }
        ],
        "responses": {
          "200": {
            "description": "Pro lookup result",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ProInfoResponse"
                }
              }
            }
          },
          "400": {
            "description": "Missing entry code",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/nest/ping": {
      "get": {
        "tags": [
          "Device"
        ],
        "summary": "Ping endpoint",
        "operationId": "ping",
        "responses": {
          "200": {
            "description": "Service heartbeat",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                }
              }
            }
          }
        }
      }
    },
    "/nest/upload": {
      "post": {
        "tags": [
          "Device"
        ],
        "summary": "Upload placeholder endpoint",
        "operationId": "upload",
        "responses": {
          "200": {
            "description": "Upload acknowledged",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UploadAck"
                }
              }
            }
          }
        }
      }
    },
    "/nest/transport/device/{serial}": {
      "get": {
        "tags": [
          "Device"
        ],
        "summary": "List object revisions for a device",
        "operationId": "listDeviceObjects",
        "security": [
          {
            "BasicAuth": []
          }
        ],
        "parameters": [
          {
            "name": "serial",
            "in": "path",
            "required": true,
            "description": "Device serial number (also inferred from Authorization headers).",
            "schema": {
              "type": "string"
            }
          },
          {
            "$ref": "#/components/parameters/XNlDeviceSerial"
          }
        ],
        "responses": {
          "200": {
            "description": "Object revision listing",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TransportSubscribeResponse"
                }
              }
            }
          }
        }
      }
    },
    "/nest/transport": {
      "post": {
        "tags": [
          "Device"
        ],
        "summary": "Subscribe to state updates",
        "operationId": "subscribeTransport",
        "description": "When `chunked=true`, the server keeps the connection open and streams newline-delimited JSON objects as changes arrive.",
        "security": [
          {
            "BasicAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/XNlDeviceSerial"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/TransportSubscribeRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Subscription acknowledgment or immediate object snapshot",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TransportSubscribeResponse"
                }
              }
            }
          }
        }
      }
    },
    "/nest/transport/put": {
      "post": {
        "tags": [
          "Device"
        ],
        "summary": "Submit updated object values",
        "operationId": "transportPut",
        "security": [
          {
            "BasicAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/XNlDeviceSerial"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/TransportPutRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Latest revisions for the submitted objects",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TransportPutResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid payload",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api-docs/swagger.json": {
      "get": {
        "tags": [
          "Control"
        ],
        "summary": "Download this OpenAPI document",
        "operationId": "getSwagger",
        "responses": {
          "200": {
            "description": "Swagger document",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string"
          }
        }
      },
      "CommandRequest": {
        "type": "object",
        "required": [
          "serial",
          "action"
        ],
        "properties": {
          "serial": {
            "type": "string",
            "description": "Thermostat serial number (uppercase alphanumeric)."
          },
          "action": {
            "type": "string",
            "description": "Action handled by `handleCommand`.",
            "enum": [
              "temp",
              "temperature",
              "away",
              "set"
            ]
          },
          "value": {
            "description": "Value for the command.",
            "oneOf": [
              {
                "type": "string"
              },
              {
                "type": "number"
              },
              {
                "type": "boolean"
              },
              {
                "type": "object",
                "additionalProperties": true
              }
            ]
          },
          "mode": {
            "type": "string",
            "description": "Requested HVAC mode when changing temperature."
          },
          "target_temperature_low": {
            "type": "number"
          },
          "target_temperature_high": {
            "type": "number"
          },
          "target_change_pending": {
            "type": "boolean"
          },
          "object": {
            "type": "string",
            "description": "Object key to update when `action` is `set`."
          },
          "field": {
            "type": "string",
            "description": "Field to set when providing a scalar `value` with the `set` action."
          }
        }
      },
      "CommandResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "message": {
            "type": "string"
          },
          "device": {
            "type": "string"
          },
          "object": {
            "type": "string"
          },
          "revision": {
            "type": "integer",
            "format": "int64"
          },
          "timestamp": {
            "type": "integer",
            "format": "int64"
          }
        }
      },
      "StatusResponse": {
        "type": "object",
        "properties": {
          "devices": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "deviceState": {
            "$ref": "#/components/schemas/DeviceState"
          }
        }
      },
      "DeviceListItem": {
        "type": "object",
        "properties": {
          "serial": {
            "type": "string"
          },
          "objects": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        }
      },
      "EntryLinksResponse": {
        "type": "object",
        "properties": {
          "czfe_url": {
            "type": "string",
            "format": "uri"
          },
          "transport_url": {
            "type": "string",
            "format": "uri"
          },
          "direct_transport_url": {
            "type": "string",
            "format": "uri"
          },
          "passphrase_url": {
            "type": "string",
            "format": "uri"
          },
          "ping_url": {
            "type": "string",
            "format": "uri"
          },
          "pro_info_url": {
            "type": "string",
            "format": "uri"
          },
          "weather_url": {
            "type": "string",
            "format": "uri"
          },
          "upload_url": {
            "type": "string",
            "format": "uri"
          },
          "software_update_url": {
            "type": "string"
          },
          "server_version": {
            "type": "string"
          },
          "tier_name": {
            "type": "string"
          }
        }
      },
      "PassphraseResponse": {
        "type": "object",
        "properties": {
          "value": {
            "type": "string",
            "description": "7-character entry key",
            "pattern": "^[A-Z0-9]+$"
          },
          "expires": {
            "type": "integer",
            "format": "int64",
            "description": "Unix timestamp (seconds) indicating when the key expires."
          }
        }
      },
      "WeatherResponse": {
        "type": "object",
        "description": "Weather payload returned by weather.nest.com.",
        "additionalProperties": true
      },
      "ProInfoResponse": {
        "type": "object",
        "description": "Mapping of entry codes to installer metadata.",
        "additionalProperties": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "HealthResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string"
          },
          "timestamp": {
            "type": "integer",
            "format": "int64"
          }
        }
      },
      "UploadAck": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string"
          }
        }
      },
      "DeviceObject": {
        "type": "object",
        "required": [
          "object_key"
        ],
        "properties": {
          "object_key": {
            "type": "string"
          },
          "object_revision": {
            "type": "integer",
            "format": "int64"
          },
          "object_timestamp": {
            "type": "integer",
            "format": "int64"
          },
          "value": {
            "type": "object",
            "additionalProperties": true
          }
        }
      },
      "DeviceObjectMap": {
        "type": "object",
        "additionalProperties": {
          "$ref": "#/components/schemas/DeviceObject"
        }
      },
      "DeviceState": {
        "type": "object",
        "additionalProperties": {
          "$ref": "#/components/schemas/DeviceObjectMap"
        }
      },
      "TransportSubscribeObject": {
        "type": "object",
        "required": [
          "object_key"
        ],
        "properties": {
          "object_key": {
            "type": "string"
          },
          "object_revision": {
            "type": "integer",
            "format": "int64",
            "description": "Revision the client currently holds."
          },
          "object_timestamp": {
            "type": "integer",
            "format": "int64",
            "description": "Timestamp of the client's copy."
          }
        }
      },
      "TransportSubscribeRequest": {
        "type": "object",
        "properties": {
          "session": {
            "type": "string",
            "description": "Optional session identifier supplied by the caller."
          },
          "chunked": {
            "type": "boolean",
            "description": "Set to true to keep the connection open and receive streaming updates."
          },
          "objects": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TransportSubscribeObject"
            }
          }
        }
      },
      "TransportSubscribeResponse": {
        "type": "object",
        "properties": {
          "objects": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/DeviceObject"
            }
          }
        }
      },
      "TransportPutObject": {
        "type": "object",
        "required": [
          "object_key"
        ],
        "properties": {
          "object_key": {
            "type": "string"
          },
          "object_revision": {
            "type": "integer",
            "format": "int64"
          },
          "object_timestamp": {
            "type": "integer",
            "format": "int64"
          },
          "value": {
            "type": "object",
            "description": "Partial state to merge with the existing object.",
            "additionalProperties": true
          }
        }
      },
      "TransportPutRequest": {
        "type": "object",
        "properties": {
          "objects": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TransportPutObject"
            }
          }
        }
      },
      "TransportPutResponse": {
        "type": "object",
        "properties": {
          "objects": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/DeviceObject"
            }
          }
        }
      }
    },
    "parameters": {
      "XNlDeviceSerial": {
        "name": "X-NL-Device-Serial",
        "in": "header",
        "required": false,
        "schema": {
          "type": "string"
        },
        "description": "Optional serial header for devices that cannot send HTTP Basic credentials."
      }
    },
    "securitySchemes": {
      "BasicAuth": {
        "type": "http",
        "scheme": "basic",
        "description": "Device serial is derived from the Basic Authorization username."
      }
    }
  }
}
